mermaid graph TD A[User Clicks Subscribe] --> B{User Has Stripe Customer?} B -->|No| C[Create Stripe Customer] B -->|Yes| D[Retrieve Customer] C --> E[Create Checkout Session] D --> E E --> F[Redirect to Stripe Checkout] F --> G[User Completes Payment] G --> H[Stripe Sends checkout.session.completed] H --> I[Webhook Validates Signature] I --> J{Event Already Processed?} J -->|Yes| K[Return 200 OK - Skip] J -->|No| L[Mark Event as Processing] L --> M[Create/Update Subscription Record] M --> N[Update User Tier] N --> O[Grant Monthly Credits] O --> P[Send Welcome Email] P --> Q[Mark Event as Processed] Q --> R[Return 200 OK] S[Subscription Renewal] --> T[Stripe Sends invoice.paid] T --> I U[Subscription Cancelled] --> V[Stripe Sends customer.subscription.deleted] V --> I W[Payment Failed] --> X[Stripe Sends invoice.payment_failed] X --> I X --> Y[Downgrade User After Grace Period] Z[User Clicks Cancel] --> AA[Create Stripe Portal Session] AA --> AB[User Manages Subscription] AB --> V